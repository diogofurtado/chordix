<!DOCTYPE html>
<html>
  <head>
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <meta charset="utf-8">

    <link href="css/style.css" rel="stylesheet"/>
    <link href="css/foundation4.css" rel="stylesheet"/>

    <!--
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    -->

    <script type='text/javascript' src='js/Tone.js'></script>
    <script type='text/javascript' src='js/chordcipher.js'></script>
    <script type='text/javascript' src='js/jquery-3.1.0.min.js'></script>
    <title>Hello World</title>
  </head>
  <body>
    <div class="cipher-container">
      <div class="row">
        <div class="large-12 columns textarea-container">
          <textarea class="textarea-input" placeholder="Cole aqui o cÃ³digo fonte"></textarea>
        </div>
        <div class="large-12 columns">
          <button id="textareaBt" class="fluid bt">ENVIAR</button>
        </div>
      </div>
    </div>
    <div class="row margin-bottom-20 margin-top-20">
      <div class="large-offset-2 large-8 columns cipher"></div>
    </div>
    <div class="row">
      <div class="large-offset-4 large-5 columns">
        <ul class="large-block-grid-2">
          <li>
            <div id="playChord" class="circle">Tocar</div>
          </li>
          <li>
            <div id="nextChord" class="circle">Tocar</div>
          </li>
        </ul>
      </div>
    </div>
    <div class="row">
      <div class="large-offset-5 large-5 columns">
        <ul class="large-block-grid-2">
          <li>
            <div id="backChord" class="circle back-chord">Voltar</div>
          </li>
        </ul>
      </div>
    </div>

    <script>
      var html = '';
      var parsedChords = '';
      var chords = []
      var container;
      var n = 0;

      $("#textareaBt").click(function(){
        html = $(".textarea-input").val();
        cifra = $(html).find('.cifra_cnt');
        $(".cipher").html(cifra);
        $(".cipher").show();
        $(".tablatura").remove();
        $(".play-chord").show();
        $(".back-chord").show();
        $(".cipher-container").hide();
        $(".circle").show();

        $('html,body').animate({
          scrollTop:$('.cipher').offset().top
        }, 1000);

        html = $(html).find('script');

        $(html).filter(function(){
          var data = $(this);

          var re = /chords.*]/i;
          data.each(function(i, elem) {
            var content = $(this).text();
            var found = content.match(re);

            if (found != null) {
              var attr = found[0];

              var chords = attr.split('chords:')[1];
              parsedChords = JSON.parse(chords);

              //parsed JSON with the array of chords
              //console.log(parsedChords);

              //list_chords = parsedChords;
              //mapChord(list_chords);
            }
          });
        });

        var j = 0;
        $("b").each(function(){
          for(i = 0; i < parsedChords.length; i++) {
            if ($(this)[0].firstChild.data == parsedChords[i].chord) {
              $(this).addClass("chord");
              $(this).attr('id', j);
              chords.push($(this));
              j++;
            }
          }
        })
      });

      var showChord = function(id) {
        container = $(".cipher");

        $(container).animate({
          scrollTop:$("#"+id).offset().top - container.offset().top + container.scrollTop()
        }, 280);

        $("#"+id).addClass('active');
        playChord($("#"+id)[0].firstChild.data);
      }

      var hideChord = function(id) {
        $("#"+id).removeClass('active');
      }

      var playChord = function(chord) {
        var flag = true;
        var i = 0;

        while (flag) {
          if (parsedChords[i].chord == chord) {
            executeChord(parsedChords[i].guitar[0]);
            flag = false;
          }
          i++;
        }
      }

      $("#playChord").click(function(){
        if(!$(this).hasClass("current") && !$("#nextChord").hasClass("current")) {
          $(this).addClass("current");
          showChord(n);
          hideChord(n-1);
        } else if($(this).hasClass("current")) {
          showChord(n);
          hideChord(n-1);
        } else if(!$(this).hasClass("current")) {
          n++;
          $(this).addClass("current");
          $("#nextChord").removeClass("current");
          showChord(n);
          hideChord(n-1);
        }
        /*
        if(n == -1) {
          n = 0;
        }
        showChord(n);
        hideChord(n-1);
        */
      });

      $("#nextChord").click(function(){
        if(!$(this).hasClass("current") && !$("#playChord").hasClass("current")) {
          $(this).addClass("current");
          showChord(n);
          hideChord(n-1);
        } else if($(this).hasClass("current")) {
          showChord(n);
          hideChord(n-1);
        } else if(!$(this).hasClass("current")) {
          n++;
          $(this).addClass("current");
          $("#playChord").removeClass("current");
          showChord(n);
          hideChord(n-1);
        }
        /*
        n++;
        showChord(n);
        hideChord(n-1);
        */
      });

      $("#backChord").click(function(){
        if(n > 0) {
          n--;
          hideChord(n+1);
          showChord(n);
        }
      });
    </script>
  </body>
</html>
